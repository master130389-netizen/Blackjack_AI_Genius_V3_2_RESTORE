name: Backup e Creazione APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  backup_and_build_apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del codice
        uses: actions/checkout@v4

      - name: Installa Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Installa dipendenze
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install flake8 requests kivy
          fi

      - name: Esegui il backup dei file (ignora file che cambiano)
        run: |
          mkdir -p git_backups
          TS=$(date +'%Y-%m-%d_%H-%M-%S')
          BACKUP="git_backups/backup_${TS}.tar.gz"
          tar \
            --exclude=.git \
            --exclude=.github \
            --exclude=git_backups \
            --exclude=pycache \
            --exclude=.venv \
            --exclude=venv \
            --exclude=android_storage/Download/BlackjackAI/logs/* \
            --warning=no-file-changed \
            -czf "$BACKUP" .
          echo "CREATED=$BACKUP" >> "$GITHUB_ENV"

      - name: Carica backup come artifact
        uses: actions/upload-artifact@v4
        with:
          name: project-backup-${{ github.run_number }}
          path: ${{ env.CREATED }}

      - name: Genera report progetto
        run: |
          python3 full_project_check.py || true
          # Se esiste report.txt lo esportiamo per il passaggio dopo
          if [ -f report.txt ]; then
            echo "REPORT_EXISTS=true" >> "$GITHUB_ENV"
          else
            echo "REPORT_EXISTS=false" >> "$GITHUB_ENV"
          fi

      - name: Invia notifica Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python3 - <<'PY'
          import os, requests, pathlib
          token=os.environ['TELEGRAM_TOKEN']
          chat=os.environ['TELEGRAM_CHAT_ID']
          backup=os.environ.get('CREATED','(sconosciuto)')
          txt = f"âœ… Backup creato.\nFile: {backup}"
          # Se report.txt esiste lo includo nel messaggio (prime 25 righe)
          if os.environ.get('REPORT_EXISTS') == 'true' and pathlib.Path('report.txt').exists():
            try:
              head = ''.join(pathlib.Path('report.txt').read_text(encoding='utf-8').splitlines(True)[:25])
              txt += "\n\nðŸ“‹ Report (inizio):\n" + head
            except Exception:
              pass
          requests.post(f"https://api.telegram.org/bot{token}/sendMessage",
                        data={"chat_id": chat, "text": txt})
          PY

      # (Fase build APK: la aggiungiamo dopo aver chiuso backup+report)
